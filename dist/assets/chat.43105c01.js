import{s as E,H as V,_ as W,r as l,c as J,ad as j,z,x as Q,Q as G,P as K,L as X,f as b,M as Y,v as I}from"./index.8c5864de.js";import{s as m}from"./index.d6bd2086.js";import"./index.6925981e.js";import{c as Z,t as ee,m as ae,w as te,I as se}from"./index.72a4dedb.js";import{_ as le}from"./LoadingMore.vue_vue_type_style_index_0_scoped_true_lang.f20c47fd.js";/* empty css              *//* empty css              *//* empty css               */const[oe,ne]=Z("divider"),ue={dashed:Boolean,hairline:ee,contentPosition:ae("center")};var re=E({name:oe,props:ue,setup(_,{slots:c}){return()=>{var v;return V("div",{role:"separator",class:ne({dashed:_.dashed,hairline:_.hairline,[`content-${_.contentPosition}`]:!!c.default})},[(v=c.default)==null?void 0:v.call(c)])}}});const ie=te(re);const ce=E({__name:"chat",setup(_){let c=G(),v=K();const{appContext:T}=X(),i=T.config.globalProperties;let w=l(!1);l(!1);let n=l();const P=()=>{b(()=>{setTimeout(()=>{var e,t,a;!((e=n.value)!=null&&e.scrollHeight)||n.value.scrollTop+n.value.clientHeight===((t=n.value)==null?void 0:t.scrollHeight)||(n.value.scrollTop=(a=n.value)==null?void 0:a.scrollHeight)})})},y=l([]),H=()=>{let e={knowledgeIds:s.value[s.value.length-1].knowledgeUsed,query:s.value[s.value.length-1].chatAsk};return new Promise((t,a)=>{i.axios.post(i.$api.knowledgeUsed,e).then(p=>{const{data:u,code:h,msg:C}=p.data;s.value[s.value.length-1].basis=u})})},k=e=>{const t={readonly:!0};return Array.isArray(e)?e.map(a=>({...a,...t})):[{...e,...t}]};let s=l([]),D=l(!1),g=l("");le.throttle(()=>{if(g.value.length<0){m("\u8BF7\u8F93\u5165\u95EE\u9898");return}O()},1500,{trailing:!1});let r=l(v.query.sessionId||"");const R=()=>new Promise((e,t)=>{i.axios.post(i.$api.createSession).then(a=>{const{data:p,code:u,msg:h}=a.data;u==0?(m("\u65B0\u804A\u5929\u521B\u5EFA\u6210\u529F"),r.value=p.sessionId,e(r.value)):(m(h),setTimeout(()=>{c.replace("/v2/login")},1e3),t())})}),x=l(!1);J(()=>w.value||x.value);let f=l(1),B=l(1);const L=()=>{w.value=!0;let e={sessionId:r.value,page:f.value};return new Promise((t,a)=>{i.axios.post(i.$api.loadSession,e).then(p=>{var A;const{data:u,code:h,msg:C}=p.data;if(h==0){let M=(A=n.value)==null?void 0:A.scrollHeight;s.value=k(u.data).reverse().concat(s.value),b(()=>{var F;n.value.scrollTop=((F=n.value)==null?void 0:F.scrollHeight)-M-157}),x.value=u.totalPage<=f.value,B.value=u.totalPage,f.value===1&&P(),t(u)}else m(C),a()}).finally(()=>{w.value=!1})})};l(1);const N=async()=>{s.value=[],r.value="",f.value=1,await R(),r.value&&S()};j(()=>{v.query.sessionId?L():N()});const o=l(),d=l(!1),S=e=>{console.log("initWebSocket",d.value),d.value?e&&e():(o.value=new WebSocket("ws://"+Y.wsUrl),d.value=!0,o.value.onopen=()=>{console.log("\u5EFA\u7ACB\u8FDE\u63A5"),e&&e()},U(),$(),q())},O=()=>{D.value=!1;var e={chatAsk:g.value,sessionId:r.value,token:z.state.user.token,knowledgeIds:y.value.length>0?y.value:""};let t={basis:[],chatAsk:g.value,modelReply:"",modelVersion:"",replyTag:"",sessionId:r.value,time:"",uniqueId:"",knowledgeUsed:y.value};s.value[s.value.length]=k(t)[0],S(()=>{var a;(a=o.value)==null||a.send(JSON.stringify(e)),g.value=""})},U=()=>{if(!o.value)return;let e="";o.value.onmessage=function(t){const a=JSON.parse(t.data.replace(/'/g,'"'));a.code===0&&a.data.isFinash===0&&(e+=a.data.data,s.value[s.value.length-1].modelReply=e),a.code===0&&a.data.isFinash===1&&(s.value[s.value.length-1]=k(a.data.data)[0],H()),P()}},$=()=>{!o.value||(o.value.onclose=function(e){d.value=!1,console.log("\u8FDE\u63A5\u5173\u95ED")})},q=()=>{!o.value||(o.value.onerror=function(e){var t;d.value=!1,(t=o.value)==null||t.close(),o.value=null,console.log(e)})};return(e,t)=>(se,I("el-input"),I("el-icon"),I("el-button"),Q("",!0))}});var we=W(ce,[["__scopeId","data-v-608e3d8f"]]);export{we as default};
